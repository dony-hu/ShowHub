# 软删除功能测试清单

## 前置准备

### 1. 数据库迁移
- [ ] 在 Supabase Dashboard 的 SQL Editor 中执行 `database/migrations/add_soft_delete.sql`
- [ ] 验证 `articles` 表已添加 `deleted_at` 字段
- [ ] 验证索引已创建：`idx_articles_deleted_at`

### 2. 管理员账号
- [ ] 确保 `dong.hu@gmail.com` 账号已创建并可以登录
- [ ] 验证该账号的 `email` 字段正确

## 功能测试

### 测试1：软删除功能（普通用户视角）

**步骤：**
1. [ ] 以普通用户身份登录
2. [ ] 创建一篇测试文章并发布
3. [ ] 在文章详情页点击"🗑️ 删除"按钮
4. [ ] 确认删除操作
5. [ ] 验证文章从黑板报列表消失
6. [ ] 尝试直接访问该文章URL，应该返回404或空数据

**预期结果：**
- ✅ 文章不再显示在任何列表中
- ✅ 数据库中该文章的 `deleted_at` 字段被设置为当前时间
- ✅ 文章记录仍然存在于数据库中（未被物理删除）

### 测试2：管理员入口显示

**步骤：**
1. [ ] 以 `dong.hu@gmail.com` 账号登录
2. [ ] 访问黑板报页面 `/blackboard`
3. [ ] 查看页面右上角用户信息区域

**预期结果：**
- ✅ 在"我要分享"按钮下方显示"🗑️ 已删除文章"按钮
- ✅ 按钮样式为红色渐变，与其他按钮有明显区分

### 测试3：查看已删除文章列表

**步骤：**
1. [ ] 以管理员身份点击"🗑️ 已删除文章"按钮
2. [ ] 或直接访问 `/admin/deleted-articles`

**预期结果：**
- ✅ 页面标题显示"🗑️ 已删除的文章"
- ✅ 显示"管理员模式"标识
- ✅ 显示已删除文章的总数
- ✅ 列出所有已删除的文章
- ✅ 每篇文章显示：标题、删除时间、创建时间、浏览量、标签、摘要、封面图

### 测试4：恢复文章

**步骤：**
1. [ ] 在已删除文章列表中选择一篇文章
2. [ ] 点击"♻️ 恢复"按钮
3. [ ] 确认恢复操作
4. [ ] 文章从已删除列表消失
5. [ ] 返回黑板报页面

**预期结果：**
- ✅ 文章重新出现在黑板报列表中
- ✅ 数据库中该文章的 `deleted_at` 字段被设置为 NULL
- ✅ 文章可以正常访问和浏览
- ✅ 已删除文章总数减1

### 测试5：永久删除

**步骤：**
1. [ ] 在已删除文章列表中选择一篇文章
2. [ ] 点击"🗑️ 永久删除"按钮
3. [ ] 查看确认对话框的警告信息
4. [ ] 确认永久删除
5. [ ] 文章从已删除列表消失

**预期结果：**
- ✅ 显示警告："⚠️ 永久删除操作不可恢复！"
- ✅ 确认后文章从数据库中彻底删除
- ✅ 无法通过任何方式再次访问该文章
- ✅ 已删除文章总数减1

### 测试6：权限控制

**步骤：**
1. [ ] 以非管理员账号（例如其他邮箱）登录
2. [ ] 访问黑板报页面
3. [ ] 尝试直接访问 `/admin/deleted-articles`

**预期结果：**
- ✅ 黑板报页面不显示"🗑️ 已删除文章"按钮
- ✅ 访问管理员页面时自动重定向回 `/blackboard`

### 测试7：黑板报列表中的删除（作者权限）

**步骤：**
1. [ ] 以文章作者身份登录
2. [ ] 在黑板报列表中找到自己的文章
3. [ ] 点击文章卡片上的"🗑️ 删除"按钮
4. [ ] 确认内联删除对话框

**预期结果：**
- ✅ 文章立即从列表消失
- ✅ 文章被软删除（`deleted_at` 被设置）
- ✅ 管理员可以在已删除列表中看到

### 测试8：查询过滤验证

**步骤：**
1. [ ] 创建3篇文章
2. [ ] 删除其中1篇
3. [ ] 检查以下API响应：
   - `getPublishedArticles()` - 应该只返回2篇
   - `getMyArticles()` - 应该只返回2篇
   - `getArticlesByCategory()` - 应该只返回未删除的文章

**预期结果：**
- ✅ 所有普通查询API都自动过滤已删除文章
- ✅ 只有管理员专用API可以查询已删除文章

## 边界情况测试

### 测试9：分页功能
- [ ] 删除超过20篇文章
- [ ] 验证已删除文章页面的分页功能正常工作

### 测试10：并发操作
- [ ] 两个管理员同时恢复同一篇文章
- [ ] 管理员恢复文章的同时，另一个管理员永久删除
- [ ] 验证操作的原子性和一致性

### 测试11：数据完整性
- [ ] 恢复一篇文章后，验证所有字段数据完整
- [ ] 验证封面图、标签、浏览量等数据没有丢失

### 测试12：性能测试
- [ ] 在有大量已删除文章的情况下，测试列表加载速度
- [ ] 验证 `deleted_at` 索引是否生效

## 回归测试

### 测试13：现有功能不受影响
- [ ] 创建新文章功能正常
- [ ] 编辑文章功能正常
- [ ] 发布/草稿状态切换正常
- [ ] 文章浏览和搜索功能正常
- [ ] 非管理员用户体验无变化

## 数据库验证

### 测试14：SQL查询验证

```sql
-- 查看所有文章状态
SELECT id, title, status, deleted_at 
FROM articles 
ORDER BY created_at DESC 
LIMIT 10;

-- 查看已删除文章
SELECT id, title, deleted_at 
FROM articles 
WHERE deleted_at IS NOT NULL;

-- 查看活跃文章
SELECT id, title 
FROM active_articles 
LIMIT 10;
```

## 测试完成标准

- [ ] 所有测试用例通过
- [ ] 无控制台错误
- [ ] UI显示正确
- [ ] 权限控制有效
- [ ] 数据完整性保持
- [ ] 性能符合预期

## 已知问题

记录测试中发现的任何问题：

1. 
2. 
3. 

## 测试人员签名

- 测试人：
- 测试日期：
- 测试环境：
- 测试结果：通过 / 失败 / 部分通过
